{% extends "base.html" %}

{% block content %}
<div class="content-page">
    <div class="content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box">
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                                <li class="breadcrumb-item"><a href="{% url 'groups_list' %}">Groups</a></li>
                                <li class="breadcrumb-item active">{{ title }}</li>
                            </ol>
                        </div>
                        <h4 class="page-title">{{ title }}</h4>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <!-- Display form-level errors -->
                            {% if form.non_field_errors %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <strong>Error:</strong>
                                <ul class="mb-0">
                                    {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            {% endif %}
                            
                            <form method="post">
                                {% csrf_token %}
                                
                                <!-- Group Information -->
                                <div class="mb-4">
                                    <h5 class="mb-3"><i class="ri-group-line me-2"></i>Group Information</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Group Name <span class="text-danger">*</span></label>
                                            {{ form.group_name }}
                                            {% if form.group_name.errors %}
                                            <div class="text-danger small">{{ form.group_name.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Group Type <span class="text-danger">*</span></label>
                                            {{ form.group_type }}
                                            {% if form.group_type.errors %}
                                            <div class="text-danger small">{{ form.group_type.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Group Leader</label>
                                            <div class="position-relative">
                                                <input type="text" id="group_leader_search" class="form-control" 
                                                       placeholder="Type to search for a farmer by name or ID (optional)..." 
                                                       autocomplete="off">
                                                <div id="group_leader_dropdown" class="list-group position-absolute w-100" 
                                                     style="max-height: 300px; overflow-y: auto; display: none; z-index: 1000; border: 1px solid #ddd; border-radius: 0.375rem; background: white; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);">
                                                </div>
                                            </div>
                                            <div style="display: none;">
                                                {{ form.group_leader }}
                                            </div>
                                            <div id="selected_leader_display" class="mt-2" style="display: none;">
                                                <div class="alert alert-info d-flex justify-content-between align-items-center">
                                                    <span><strong>Selected:</strong> <span id="selected_leader_name"></span></span>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clear_leader_btn">
                                                        <i class="ri-close-line"></i> Clear
                                                    </button>
                                                </div>
                                            </div>
                                            {% if form.group_leader.errors %}
                                            <div class="text-danger small">{{ form.group_leader.errors }}</div>
                                            {% endif %}
                                            <small class="text-muted">Select a farmer to be the group leader (optional - leave blank if no leader)</small>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Description</label>
                                            {{ form.description }}
                                            {% if form.description.errors %}
                                            <div class="text-danger small">{{ form.description.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="form-check form-switch">
                                                {{ form.is_active }}
                                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                                    Active Status
                                                </label>
                                            </div>
                                            <small class="text-muted">Toggle to activate or deactivate this group</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <a href="{% url 'groups_list' %}" class="btn btn-secondary">
                                        <i class="ri-close-line me-1"></i> Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="ri-save-line me-1"></i> Save Group
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('group_leader_search');
    const dropdown = document.getElementById('group_leader_dropdown');
    const selectField = document.getElementById('id_group_leader');
    const selectedDisplay = document.getElementById('selected_leader_display');
    const selectedName = document.getElementById('selected_leader_name');
    const clearBtn = document.getElementById('clear_leader_btn');
    
    // Get all options from the select field
    const allOptions = Array.from(selectField.options);
    
    // Set initial display if a farmer is already selected
    if (selectField.value) {
        const selectedOption = selectField.options[selectField.selectedIndex];
        if (selectedOption.value) {
            searchInput.value = selectedOption.text;
            selectedName.textContent = selectedOption.text;
            selectedDisplay.style.display = 'block';
        }
    }
    
    // Filter options based on search input
    function filterOptions(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        dropdown.innerHTML = '';
        
        if (term === '') {
            dropdown.style.display = 'none';
            return;
        }
        
        // Add "Clear selection" option if something is selected
        if (selectField.value) {
            const clearItem = document.createElement('button');
            clearItem.type = 'button';
            clearItem.className = 'list-group-item list-group-item-action';
            clearItem.innerHTML = '<i class="ri-close-line me-2"></i><em>Clear selection (leave blank)</em>';
            clearItem.onclick = function() {
                selectField.value = '';
                searchInput.value = '';
                selectedDisplay.style.display = 'none';
                dropdown.style.display = 'none';
            };
            dropdown.appendChild(clearItem);
        }
        
        // Filter and display matching options
        const filtered = allOptions.filter(option => {
            if (!option.value) return false; // Skip empty option
            const text = option.text.toLowerCase();
            return text.includes(term);
        });
        
        if (filtered.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'list-group-item text-muted';
            noResults.textContent = 'No farmers found';
            dropdown.appendChild(noResults);
        } else {
            filtered.forEach(option => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action';
                item.textContent = option.text;
                item.onclick = function() {
                    selectField.value = option.value;
                    searchInput.value = option.text;
                    selectedName.textContent = option.text;
                    selectedDisplay.style.display = 'block';
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(item);
            });
        }
        
        dropdown.style.display = 'block';
    }
    
    // Handle search input
    searchInput.addEventListener('input', function() {
        filterOptions(this.value);
    });
    
    // Handle focus
    searchInput.addEventListener('focus', function() {
        if (this.value.trim()) {
            filterOptions(this.value);
        }
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // Clear selection button
    clearBtn.addEventListener('click', function() {
        selectField.value = '';
        searchInput.value = '';
        selectedDisplay.style.display = 'none';
        dropdown.style.display = 'none';
    });
});
</script>

<style>
#group_leader_dropdown .list-group-item {
    cursor: pointer;
    border: none;
    border-bottom: 1px solid #eee;
    padding: 0.75rem 1rem;
}
#group_leader_dropdown .list-group-item:hover {
    background-color: #f8f9fa;
}
#group_leader_dropdown .list-group-item:last-child {
    border-bottom: none;
}
</style>
{% endblock content %}

